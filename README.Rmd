---
output:
  html_document:
    highlight: tango
    keep_md: yes
    theme: readable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE)
```

## ![CTSgetR](https://github.com/dgrapov/CTSgetR/blob/master/inst/ctsgetR_logo.png?raw=true)

<hr>
### R interface to the [Chemical Translation Service (CTS)](http://cts.fiehnlab.ucdavis.edu/)
<hr>

#### `CTSgetR` provides a consitent interface to translation of chemical names and over 200 database identifiers including `InChIKey`, `HMDB`, `KEGG` and `PubChem`. Translation of chemical names is hard. Use `CTSgetR` to robustly translate chemical names to other identifiers through 1) conversion to `InChIKey` 2) `biological` or `popularity` scoring and 3) translation to over 200 biological database identifiers. `CTSgetR` uses a sqlite database to cache and speed all of your routine translations.

### Installation (see below for a `docker` example)
```{r, message=FALSE,warning=FALSE,eval=FALSE}
install_github("dgrapov/CTSgetR")
```

### Make sure CTS API is available
```{r}
library(CTSgetR)
GET('https://cts.fiehnlab.ucdavis.edu/services') %>%
  http_status(.) %>%
  {if( .$category != 'Success'){stop('Oops looks like https://cts.fiehnlab.ucdavis.edu/services is down!') }} 
```

### View some of the possible translation options between > 200 databases
```{r}
trans<-unlist(valid_from())
head(trans,10)
```

### Find a database of interest
```{r}
want<-'CID'
trans[grepl(want,trans,ignore.case=TRUE)]
```


### Initialize a local database to speed up routine queries
```{r}
db_name<-'cts.sqlite'
init_CTSgetR_db(db_name)
db_stats()
```


### Translation examples

#### `Chemical Name` to `InChIKey`
```{r,message=FALSE}

id<-c("alanine",'lactic acid')
from<-"Chemical Name"
to<-"InChIKey"

CTSgetR(id,from,to,db_name)
```

#### One identifier to many
```{r}
id<-c("alanine",'lactic acid')
from<-"Chemical Name"
to<- c( "PubChem CID", "KEGG","Human Metabolome Database")

(out<-to %>%
  map(~CTSgetR(id,from,.,db_name)) 
  %>% do.call('rbind',.))


```



#### Many identifiers to one
```{r}

to<- "InChIKey"

(out2<-out %>%
  pmap_dfr(function(...) {
    tmp <- tibble(...)
    CTSgetR(tmp$key,tmp$to,to,db_name)
  
  }))

```

<hr>
## Deploy `CTSgetR` as a `docker`ized `API`
<hr>

### The following [docker]() image and [docker-compose]() commands can be used to `build` and run the `CTSgetR` package as an [opencpu](https://hub.docker.com/r/opencpu/ubuntu-18.04) based `API`.

* ### [CTSgetR image]()
* ### [CTSgetR-client](): openAPI compliant client for the `CTSgetR` `API`

### The `CTSgetR` image provides the following endpoints:
* ### `localhost/ocpu/`: [opencpu-server](https://www.opencpu.org/)
* ### `localhost/rstudio/` : [rstudio server](https://hub.docker.com/r/opencpu/rstudio) (use user: opencpu and password:mypassword )

### `Image:`
#### `build`
```
export rstudio_pass=mypassword # rstudio server password for user opencpu
docker-compose -f docker-compose.yml build --force-rm

```

#### `run`
```
#mount to persist internal sqlite DB between updates 
export ctsgetr_db_mount=/mypath
docker-compose -f docker-compose.yml up -d

```